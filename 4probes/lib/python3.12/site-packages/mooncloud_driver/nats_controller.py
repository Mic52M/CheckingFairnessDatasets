import json
from typing import Any, Coroutine
import nats
import mooncloud_driver.result as result
import mooncloud_driver.config as config
import dataclasses


class NatsController():

    def __init__(self,current_config:config.Config):
        self.nc=None
        self.js=None
        self.current_config=current_config
        self.url="tls://"+self.current_config.nats_user+":"+self.current_config.nats_password+"@"+self.current_config.nats_host+":"+self.current_config.nats_port

    async def connect(self):
        self.nc = await nats.connect(self.url)
        self.js=self.nc.jetstream()

    async def publishResult(self, subject:str, result_to_write:result.EWResult) -> Coroutine[Any,Any,nats.js.api.PubAck]:
        return await self.js.publish(subject, json.dumps(dataclasses.asdict(result_to_write)).__str__().encode())
